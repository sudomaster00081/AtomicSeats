<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¬ Seat Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --available: #28a745;
            --held: #ffc107;
            --booked: #dc3545;
            --selected: #17a2b8;
            --screen: #e9ecef;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 50px;
        }
        
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .screen {
            background-color: var(--screen);
            height: 30px;
            border-radius: 8px;
            margin: 20px auto 30px;
            width: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #495057;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .seats-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            padding: 25px;
        }
        
        .row-label {
            font-weight: bold;
            margin-right: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            min-width: 30px;
        }
        
        .seat-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 5px 0;
        }
        
        .seat {
            width: 42px;
            height: 42px;
            margin: 3px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            position: relative;
            user-select: none;
        }
        
        .seat.available {
            background-color: var(--available);
        }
        
        .seat.available:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
        }
        
        .seat.held {
            background-color: var(--held);
            color: #212529;
        }
        
        .seat.booked {
            background-color: var(--booked);
            cursor: not-allowed;
            opacity: 0.85;
        }
        
        .seat.selected {
            background-color: var(--selected);
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.5);
        }
        
        .seat::after {
            content: '';
            position: absolute;
            bottom: -8px;
            font-size: 0.6rem;
            color: #6c757d;
        }
        
        .seat.A::after { content: "A"; }
        .seat.B::after { content: "B"; }
        .seat.C::after { content: "C"; }
        .seat.D::after { content: "D"; }
        .seat.E::after { content: "E"; }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        .action-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            padding: 25px;
            margin-top: 25px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .status-badge {
            font-size: 0.9rem;
            padding: 0.35rem 0.8rem;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .count-display {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
            flex-wrap: wrap;
        }
        
        .count-item {
            padding: 15px;
            min-width: 120px;
            border-radius: 10px;
            margin: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .count-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .hold-timer {
            font-size: 0.75rem;
            margin-top: 3px;
            color: #e83e8c;
            font-weight: 500;
            display: none;
        }
        
        .seat.held .hold-timer {
            display: block;
        }
        
        @media (max-width: 768px) {
            .seat {
                width: 36px;
                height: 36px;
                font-size: 0.65rem;
            }
            .row-label {
                font-size: 0.85rem;
            }
            .screen {
                width: 95%;
                height: 25px;
                font-size: 0.85rem;
            }
            .action-panel, .seats-container {
                padding: 15px;
                margin: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-film"></i> Movie Show Seat Management</h1>
            <p class="lead">Real-time seat reservation system with concurrency safety</p>
            <div class="d-flex justify-content-center gap-3 mt-3">
                <span class="badge bg-success fs-6"><i class="fas fa-shield-alt"></i> Concurrency Safe</span>
                <span class="badge bg-primary fs-6"><i class="fas fa-database"></i> PostgreSQL Backend</span>
                <span class="badge bg-warning text-dark fs-6"><i class="fas fa-hourglass-half"></i> Auto Expiry</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="fas fa-info-circle fa-2x me-3"></i>
            <div>
                <strong>Demo Show:</strong> Avengers Endgame (7:00 PM) â€¢ 
                <strong>Seat Selection:</strong> Click available seats (green) to select â€¢ 
                <strong>Holds:</strong> Expire after 10 minutes if not booked
            </div>
        </div>

        <div class="seats-container">
            <div class="screen">
                <span>SCREEN THIS WAY</span>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--available);"></div>
                    <span>Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--held); color: #212529;"></div>
                    <span>Held (Expires Soon)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--booked);"></div>
                    <span>Booked</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: var(--selected);"></div>
                    <span>Selected</span>
                </div>
            </div>
            
            <div id="seats-grid">
                <!-- Seats will be dynamically generated here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading seat map...</p>
                </div>
            </div>
        </div>
        
        <div class="count-display">
            <div class="count-item bg-success bg-opacity-10 text-success">
                <div class="count-value" id="available-count">--</div>
                <div>Available</div>
            </div>
            <div class="count-item bg-warning bg-opacity-10 text-warning">
                <div class="count-value" id="held-count">--</div>
                <div>Held</div>
            </div>
            <div class="count-item bg-danger bg-opacity-10 text-danger">
                <div class="count-value" id="booked-count">--</div>
                <div>Booked</div>
            </div>
            <div class="count-item bg-info bg-opacity-10 text-info">
                <div class="count-value" id="selected-count">0</div>
                <div>Selected</div>
            </div>
        </div>
        
        <div class="action-panel">
            <h3 class="mb-4 text-center"><i class="fas fa-ticket-alt"></i> Reservation Actions</h3>
            
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label"><i class="fas fa-clock"></i> Hold Duration (seconds)</label>
                    <input type="number" class="form-control" id="hold-duration" min="60" max="1800" value="600">
                    <div class="form-text">Seats will be held for this duration before auto-releasing</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label"><i class="fas fa-key"></i> Hold ID (for booking/release)</label>
                    <input type="text" class="form-control" id="hold-id-input" placeholder="Enter hold_id from hold response">
                </div>
            </div>
            
            <div class="d-grid gap-3 mb-4">
                <button id="hold-btn" class="btn btn-warning btn-lg" disabled>
                    <i class="fas fa-lock"></i> Hold Selected Seats (0)
                </button>
                <button id="book-btn" class="btn btn-success btn-lg">
                    <i class="fas fa-check-circle"></i> Book Hold
                </button>
                <button id="release-btn" class="btn btn-danger btn-lg">
                    <i class="fas fa-unlock"></i> Release Hold
                </button>
            </div>
            
            <div class="alert alert-light border" id="response-area" style="min-height: 60px; display: none;">
                <div class="d-flex">
                    <div class="flex-shrink-0 me-2">
                        <i class="fas fa-info-circle fa-2x text-primary mt-1"></i>
                    </div>
                    <div id="response-message"></div>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <button id="refresh-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> Refresh Seat Status
                </button>
                <button id="clear-btn" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-eraser"></i> Clear Selection
                </button>
            </div>
        </div>
        
        <div class="card mt-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-terminal"></i> API Endpoints (For Developers)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-success"><i class="fas fa-code"></i> Hold Seats</h6>
                                <p class="card-text"><code>POST /shows/avengers_2026_7pm/hold</code></p>
                                <p class="mb-1"><strong>Body:</strong> <code>{"seat_ids": ["A1","A2"], "hold_duration_seconds": 600}</code></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-info"><i class="fas fa-code"></i> Book Hold</h6>
                                <p class="card-text"><code>POST /shows/avengers_2026_7pm/book</code></p>
                                <p class="mb-1"><strong>Body:</strong> <code>{"hold_id": "uuid-here"}</code></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-danger"><i class="fas fa-code"></i> Release Hold</h6>
                                <p class="card-text"><code>POST /shows/avengers_2026_7pm/release-hold</code></p>
                                <p class="mb-1"><strong>Body:</strong> <code>{"hold_id": "uuid-here"}</code></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-secondary"><i class="fas fa-code"></i> Get Status</h6>
                                <p class="card-text"><code>GET /shows/avengers_2026_7pm/seats</code></p>
                                <p class="mb-1"><strong>Response:</strong> Seat counts + detailed status</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script>
        // DOM Elements
        const seatsGrid = document.getElementById('seats-grid');
        const holdBtn = document.getElementById('hold-btn');
        const bookBtn = document.getElementById('book-btn');
        const releaseBtn = document.getElementById('release-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const clearBtn = document.getElementById('clear-btn');
        const holdDurationInput = document.getElementById('hold-duration');
        const holdIdInput = document.getElementById('hold-id-input');
        const responseArea = document.getElementById('response-area');
        const responseMessage = document.getElementById('response-message');
        const selectedCountEl = document.getElementById('selected-count');
        const availableCountEl = document.getElementById('available-count');
        const heldCountEl = document.getElementById('held-count');
        const bookedCountEl = document.getElementById('booked-count');
        
        // State
        let seatData = {};
        let selectedSeats = new Set();
        const SHOW_ID = 'avengers_2026_7pm';
        const API_BASE = '/shows/' + SHOW_ID;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSeatStatus();
            setupEventListeners();
            
            // Auto-refresh every 15 seconds
            setInterval(loadSeatStatus, 15000);
        });
        
        function setupEventListeners() {
            holdBtn.addEventListener('click', holdSelectedSeats);
            bookBtn.addEventListener('click', bookHold);
            releaseBtn.addEventListener('click', releaseHold);
            refreshBtn.addEventListener('click', loadSeatStatus);
            clearBtn.addEventListener('click', clearSelection);
            
            holdDurationInput.addEventListener('change', (e) => {
                const val = parseInt(e.target.value);
                if (val < 60) e.target.value = 60;
                if (val > 1800) e.target.value = 1800;
            });
        }
        
        async function loadSeatStatus() {
            try {
                const response = await fetch(`${API_BASE}/seats`);
                if (!response.ok) throw new Error('Failed to load seat status');
                
                const data = await response.json();
                renderSeats(data.seats);
                updateCounts(data);
                showResponse('Seat status updated successfully', 'success', 2000);
            } catch (error) {
                showError('Failed to load seat status: ' + error.message);
                renderErrorState();
            }
        }
        
        function renderSeats(seats) {
            // Group seats by row (A-E)
            const rows = { A: [], B: [], C: [], D: [], E: [] };
            
            seats.forEach(seat => {
                const row = seat.seat_id.charAt(0);
                if (rows[row]) {
                    rows[row].push(seat);
                    seatData[seat.seat_id] = seat;
                }
            });
            
            // Sort seats within each row by number
            Object.keys(rows).forEach(row => {
                rows[row].sort((a, b) => {
                    const numA = parseInt(a.seat_id.substring(1));
                    const numB = parseInt(b.seat_id.substring(1));
                    return numA - numB;
                });
            });
            
            // Generate HTML
            let html = '';
            Object.entries(rows).forEach(([rowLabel, rowSeats]) => {
                html += `
                <div class="seat-row">
                    <div class="row-label">${rowLabel}</div>
                    <div class="d-flex flex-wrap">
                `;
                
                rowSeats.forEach(seat => {
                    const isSelected = selectedSeats.has(seat.seat_id);
                    const isAvailable = seat.status === 'available';
                    const baseClass = `seat ${seat.status} ${seat.seat_id.charAt(0)}`;
                    const classes = isSelected ? `${baseClass} selected` : baseClass;
                    const disabled = seat.status !== 'available' ? 'disabled' : '';
                    
                    html += `
                    <div class="${classes}" 
                         data-seat-id="${seat.seat_id}"
                         ${disabled}
                         title="${seat.seat_id} - ${seat.status.toUpperCase()}${seat.hold_expires_at ? ' (Expires: ' + new Date(seat.hold_expires_at).toLocaleTimeString() + ')' : ''}">
                        ${seat.seat_id.substring(1)}
                        ${seat.status === 'held' && seat.hold_expires_at ? 
                          `<div class="hold-timer">${formatTimeUntil(new Date(seat.hold_expires_at))}</div>` : ''}
                    </div>
                    `;
                });
                
                html += `
                    </div>
                </div>
                `;
            });
            
            seatsGrid.innerHTML = html;
            attachSeatClickHandlers();
        }
        
        function attachSeatClickHandlers() {
            document.querySelectorAll('.seat.available').forEach(seatEl => {
                seatEl.addEventListener('click', () => {
                    const seatId = seatEl.dataset.seatId;
                    
                    if (selectedSeats.has(seatId)) {
                        selectedSeats.delete(seatId);
                        seatEl.classList.remove('selected');
                    } else {
                        selectedSeats.add(seatId);
                        seatEl.classList.add('selected');
                    }
                    
                    updateSelectedCount();
                    updateHoldButton();
                });
            });
        }
        
        function updateCounts(data) {
            availableCountEl.textContent = data.available_seats || 0;
            heldCountEl.textContent = data.held_seats || 0;
            bookedCountEl.textContent = data.booked_seats || 0;
        }
        
        function updateSelectedCount() {
            selectedCountEl.textContent = selectedSeats.size;
        }
        
        function updateHoldButton() {
            holdBtn.disabled = selectedSeats.size === 0;
            holdBtn.innerHTML = `<i class="fas fa-lock"></i> Hold Selected Seats (${selectedSeats.size})`;
        }
        
        function clearSelection() {
            selectedSeats.clear();
            document.querySelectorAll('.seat.selected').forEach(el => {
                el.classList.remove('selected');
            });
            updateSelectedCount();
            updateHoldButton();
            showResponse('Selection cleared', 'info', 1500);
        }
        
        async function holdSelectedSeats() {
            if (selectedSeats.size === 0) return;
            
            const duration = parseInt(holdDurationInput.value) || 600;
            const payload = {
                seat_ids: Array.from(selectedSeats),
                hold_duration_seconds: duration
            };
            
            try {
                showResponse('Creating hold...', 'info');
                const response = await fetch(`${API_BASE}/hold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResponse(`âœ… Hold created! ID: ${data.hold_id}<br>Expires: ${new Date(data.expires_at).toLocaleString()}`, 'success', 8000);
                    holdIdInput.value = data.hold_id;
                    clearSelection();
                    setTimeout(loadSeatStatus, 500);
                } else {
                    showError(`Hold failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                showError('Hold request failed: ' + error.message);
            }
        }
        
        async function bookHold() {
            const holdId = holdIdInput.value.trim();
            if (!holdId) {
                showError('Please enter a hold ID');
                return;
            }
            
            try {
                showResponse('Booking hold...', 'info');
                const response = await fetch(`${API_BASE}/book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hold_id: holdId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResponse(`âœ… Booking confirmed! Booking ID: ${data.booking_id}<br>Booked at: ${new Date(data.booked_at).toLocaleString()}`, 'success', 8000);
                    holdIdInput.value = '';
                    setTimeout(loadSeatStatus, 500);
                } else {
                    showError(`Booking failed: ${data.error || 'Invalid hold'}`);
                }
            } catch (error) {
                showError('Booking request failed: ' + error.message);
            }
        }
        
        async function releaseHold() {
            const holdId = holdIdInput.value.trim();
            if (!holdId) {
                showError('Please enter a hold ID');
                return;
            }
            
            try {
                showResponse('Releasing hold...', 'info');
                const response = await fetch(`${API_BASE}/release-hold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hold_id: holdId })
                });
                
                if (response.ok) {
                    showResponse('âœ… Hold released successfully', 'success', 3000);
                    holdIdInput.value = '';
                    setTimeout(loadSeatStatus, 500);
                } else {
                    showError('Release failed: Hold not found or already expired');
                }
            } catch (error) {
                showError('Release request failed: ' + error.message);
            }
        }
        
        function renderErrorState() {
            seatsGrid.innerHTML = `
                <div class="alert alert-danger text-center" role="alert">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4>Unable to Load Seat Map</h4>
                    <p class="mb-0">Please check your connection or try refreshing the page</p>
                    <button class="btn btn-primary mt-3" onclick="loadSeatStatus()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
        
        function showResponse(message, type = 'info', autoHide = 3000) {
            responseArea.style.display = 'block';
            responseMessage.innerHTML = message;
            
            // Set color based on type
            responseArea.className = 'alert alert-light border';
            if (type === 'success') responseArea.classList.add('border-success');
            if (type === 'danger') responseArea.classList.add('border-danger');
            if (type === 'warning') responseArea.classList.add('border-warning');
            if (type === 'info') responseArea.classList.add('border-info');
            
            if (autoHide > 0) {
                setTimeout(() => {
                    if (responseArea.innerHTML === message) {
                        responseArea.style.display = 'none';
                    }
                }, autoHide);
            }
        }
        
        function showError(message) {
            showResponse(`<i class="fas fa-exclamation-circle me-2"></i>${message}`, 'danger', 5000);
            showToast(message, 'error');
        }
        
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const colorMap = {
                success: 'bg-success',
                error: 'bg-danger',
                warning: 'bg-warning',
                info: 'bg-info'
            };
            
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const toastHTML = `
                <div id="${toastId}" class="toast show mb-2" role="alert" aria-live="assertive" aria-atomic="true" style="min-width: 300px;">
                    <div class="toast-header ${colorMap[type] || 'bg-primary'} text-white">
                        <i class="fas ${iconMap[type] || 'fa-bell'} me-2"></i>
                        <strong class="me-auto">Seat System</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const toastEl = document.getElementById(toastId);
                if (toastEl) toastEl.remove();
            }, 5000);
        }
        
        function formatTimeUntil(expiryDate) {
            const now = new Date();
            const diff = expiryDate - now;
            
            if (diff <= 0) return 'EXPIRED';
            
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            return `${minutes}m ${seconds}s`;
        }
        
        // Initialize with loading state
        setTimeout(() => {
            if (seatsGrid.innerHTML.includes('Loading')) {
                loadSeatStatus();
            }
        }, 300);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>